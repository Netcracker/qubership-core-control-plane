# Blue-Green promote/rollback algorithm
This document describes control-plane logic in promote/rollback operations. It contains promote and rollback algorithm descriptions as they should be.

[[_TOC_]]

## What happens with versions
### On promote:

* All the CANDIDATEs except the one chosen for promote are deleted before any other actions.
* ACTIVE → LEGACY
* CANDIDATE → ACTIVE
* LEGACY → ARCHIEVE
* The oldest extra ARCHIEVE versions are deleted according to history size (history size == ARCHIVE versions count)
### On rollback:

* ACTIVE → CANDIDATE
* LEGACY → ACTIVE
* ARCHIVED versions do not move to LEGACY => there is no way to do 2 rollbacks in a row

## What happens with endpoints and routes
1. If cluster has endpoints in current ACTIVE version but has no endpoints in future ACTIVE version we assume this is non-bg cluster. Except rolling back from the version equal to these endpoints' initial version: in this case after rollback endpoints will become CANDIDATE again.
2. Non-bg cluster endpoints and their routes TOGETHER must be moved from original ACTIVE version to future ACTIVE version.
3. All the autogenerated routes from current CANDIDATE/LEGACY version are being deleted before any other actions with routes/endpoints.
4. Prohibited routes only needed to avoid accessing ACTIVE version by fallback in case header X-Version is set to some LEGACY or CANDIDATE version and requested route only presents in ACTIVE version.
5. Registering new CANDIDATE routes initiates prohibited routes creation, but only if cluster has routes in ACTIVE version: we are generating forbidden pairs in CANDIDATE for each route from delta that presents in ACTIVE. For both CANDIDATE routes registration and rollback this is the same algorithm of prohibited routes generation.
6. Don't need to create prohibited routes in target ACTIVE version ever: if there is no route in ACTIVE, you will get 404 by default anyway.
7. Since 4 and 5, we do need to create prohibited routes both on promote and rollback.

So we create prohibited routes only for bg clusters:

* On **promote** in **future LEGACY** version.
* On **rollback** in **future CANDIDATE** version.