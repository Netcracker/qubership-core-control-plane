# Cookie Based Stateful Session

This guide covers Service Mesh support for stateful sessions based on cookies. 

[[_TOC_]]

## Overview

The feature is based on envoyproxy [Cookie Based Stateful Session](https://www.envoyproxy.io/docs/envoy/v1.21.1/api-v3/extensions/http/stateful_session/cookie/v3/cookie.proto). 

It allows to configure sticky session that will not be rebalanced even when the microservice pod is being scaled.

You can configure stateful session on Cluster, Endpoint or Route configuration level. Find the API and examples below.

## Limitations

* Different b/g version of microservice cannot have similar cookie names, because stateful session load balancing has higher priority then b/g load balancing. So postfix version will be automatically added to the cookie name. 
E.g. if you specify cookie name `sticky-cookie` in stateful session configuration for b/g version `v1`, actual cookie generated by gateway will be named `sticky-cookie-v1`.
* After candidate promotion cookies used by clients in `Active` version will be recalculated, since physically traffic should go to newly `Active` pods. 

## Declarative API

### Apply stateful session configuration
```yaml
kind: StatefulSession
apiVersion: nc.core.mesh/v3
metadata:
  namespace: '' # optional: if empty, namespace of the control-plane will be used
spec:
  namespace: '' # optional: will be taken from metadata by default
  gateways: ["public-gateway-service", "private-gateway-service"]
  cluster: "trace-service" # microservice family name
  version: "v1" # optional: affects ACTIVE version by default
  port: 8080 # optional: affects all known service ports by default
  hostname: trace-service-v1 # optional: to specify hostname of custom endpoint
  enabled: true # optional: use false to disable cluster stateful session configuration for this specific endpoint
  cookie:
    name: sticky-cookie # optional: on empty name new unique name will be generated
    ttl: 0
    path: /
```

### Delete stateful session configuration
```yaml
kind: StatefulSession
apiVersion: nc.core.mesh/v3
metadata:
  namespace: '' # optional: if empty, namespace of the control-plane will be used
spec:
  namespace: '' # optional: will be taken from metadata by default
  gateways: ["public-gateway-service", "private-gateway-service"]
  cluster: "trace-service" # microservice family name
  version: "v1" # optional: affects ACTIVE version by default
  port: 8080 # optional: affects all known service ports by default
  hostname: trace-service-v1 # optional: to specify hostname of custom endpoint
```
 
## REST API
* [Apply stateful session configuration REST API](../api/control-plane-api.md#apply-cookie-based-stateful-session-configuration)
* [Delete stateful session configuration REST API](../api/control-plane-api.md#delete-cookie-based-stateful-session-configuration)
* [Per-route stateful session configuration](../api/control-plane-api.md#rule)

## Examples

### Apply stateful session configuration for cluster

The following configuration will apply cookie based stateful session for cluster `trace-service`:
```yaml
kind: StatefulSession
apiVersion: nc.core.mesh/v3
metadata:
  namespace: '' # optional: if empty, namespace of the control-plane will be used
spec:
  gateways: ["public-gateway-service", "private-gateway-service"]
  cluster: "trace-service" # microservice family name
  version: "v1" # optional: affects ACTIVE version by default
  cookie:
    name: trace-service-sticky # optional: on empty name new unique name will be generated
    ttl: 0
    path: /
```
Now public and private gateways will generate and use `trace-service-sticky-v1` cookie for all the requests routed to `trace-service` cluster. 

### Apply stateful session configuration for endpoint

The following configuration will apply cookie based stateful session for endpoint `trace-service-v1:8080`:
```yaml
kind: StatefulSession
apiVersion: nc.core.mesh/v3
metadata:
  namespace: '' # optional: if empty, namespace of the control-plane will be used
spec:
  gateways: ["public-gateway-service", "private-gateway-service"]
  cluster: "trace-service" # microservice family name
  port: 8080
  version: "v1" # optional: affects ACTIVE version by default
  cookie:
    name: trace-service-sticky # optional: on empty name new unique name will be generated
    ttl: 0
    path: /
```
Now public and private gateways will generate and use `trace-service-sticky-v1` cookie for all the requests routed to `trace-service-v1:8080`. 

Additionally, you can specify custom hostname of the endpoint: 
```yaml
kind: StatefulSession
apiVersion: nc.core.mesh/v3
metadata:
  namespace: '' # optional: if empty, namespace of the control-plane will be used
spec:
  gateways: ["public-gateway-service", "private-gateway-service"]
  cluster: "trace-service" # microservice family name
  hostname: "trace-service-tls"
  port: 8443
  version: "v1" # optional: affects ACTIVE version by default
  cookie:
    name: trace-service-sticky # optional: on empty name new unique name will be generated
    ttl: 0
    path: /
```
Based on this configuration, public and private gateways will generate and use `trace-service-sticky-v1` cookie for all the requests routed to `trace-service-tls:8443`. 

### Disabling stateful session configuration for specific endpoint

E.g. you have configured stateful session for cluster `trace-service`, and now yoo want to disable it for single endpoint of the cluster. 
The following configuration will disable stateful session for endpoint `trace-service-v1:8080`:
```yaml
kind: StatefulSession
apiVersion: nc.core.mesh/v3
metadata:
  namespace: '' # optional: if empty, namespace of the control-plane will be used
spec:
  gateways: ["public-gateway-service", "private-gateway-service"]
  cluster: "trace-service" # microservice family name
  port: 8080
  version: "v1" # optional: affects ACTIVE version by default
  enabled: false # disables parent (cluster-level) stateful session configuration for the endpoint
```

### Applying stateful session configuration for route

You can configure cookie based stateful session for any route in RouteConfiguration spec:
```yaml
apiVersion: nc.core.mesh/v3
kind: RouteConfiguration
metadata:
  name: trace-service-public-routes
  namespace: "${ENV_NAMESPACE}"
spec:
  gateways: ["public-gateway-service"]
  virtualServices:
  - name: public-gateway-service
    hosts: ["*"]
    routeConfiguration:
      version: "${ENV_DEPLOYMENT_VERSION}"
      routes:
      - destination:
          cluster: "${ENV_SERVICE_NAME}"
          endpoint: http://${ENV_DEPLOYMENT_RESOURCE_NAME}:8080
        rules:
        - match:
            prefix: /api/v1/trace-service/common-info
          prefixRewrite: /api/v1/common-info
          statefulSession:
            enabled: true # optional: unset to override per-Cluster and per-Endpoint statefulSession configuration
            cookie:
              name: sticky-${ENV_SERVICE_NAME} # optional: on empty name new unique name will be generated based on cluster name
              ttl: 0
              path: /api/v1/trace-service/common-info
```

After applying this spec, public gateway will generate and use cookie for stickiness 
on every request to `/api/v1/trace-service/common-info`.

### Delete stateful session configuration for cluster/endpoint

You can delete stateful session configuration for cluster or endpoint by applying the same StatefulSession spec, 
but without `enabled` and `cookie` fields, e.g.:

```yaml
kind: StatefulSession
apiVersion: nc.core.mesh/v3
metadata:
  namespace: '' # optional: if empty, namespace of the control-plane will be used
spec:
  gateways: ["public-gateway-service", "private-gateway-service"]
  cluster: "trace-service" # microservice family name
  port: 8080
  version: "v1" # optional: affects ACTIVE version by default
```

### Delete stateful session configuration for route

You can delete route-level stateful session by registering the same route without `statefulSession` field.
```yaml
apiVersion: nc.core.mesh/v3
kind: RouteConfiguration
metadata:
  name: trace-service-public-routes
  namespace: "${ENV_NAMESPACE}"
spec:
  gateways: ["public-gateway-service"]
  virtualServices:
  - name: public-gateway-service
    hosts: ["*"]
    routeConfiguration:
      version: "${ENV_DEPLOYMENT_VERSION}"
      routes:
      - destination:
          cluster: "${ENV_SERVICE_NAME}"
          endpoint: http://${ENV_DEPLOYMENT_RESOURCE_NAME}:8080
        rules:
        - match:
            prefix: /api/v1/trace-service/common-info
          prefixRewrite: /api/v1/common-info
```